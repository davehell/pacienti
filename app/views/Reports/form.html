#{extends 'main.html' /}

#{ifnot zprava?.id}
    #{set title:'Nové vyšetření' /}
#{/ifnot}
#{else}
    #{set title:'Vyšetření' /}
#{/else}

#{ifErrors}
    <p class="error">
        Opravte chyby ve formuláři!
    </p>
#{/ifErrors}


#{form @mySave(zprava?.id)}
#{if zprava?.id}
<p>
 <span class="button">#{a @Reports.report(zprava.id), title:"Zobrazit závěrečnou zprávu tohoto vyšetření"}závěrečná zpráva#{/a}</span>
</p>
  <div class="span-15">
#{/if}

<fieldset>
  <legend>Informace o vyšetření</legend>

<p>
  <label>pacient</label>
  <span class="infoInput">#{a @Patients.detail(pacient?.id), title:"Zobrazit detail pacienta"}${pacient?.getKod()}#{/a}, ${pacient?.toString()} </span>
</p>


#{if zprava?.bioMaterial?.id}
  <input type="hidden" name="zprava.bioMaterial.id" value="${zprava.bioMaterial.id}">
  <p>
    <label>biologický materiál</label>
    <span class="infoInput">${zprava?.bioMaterial?.typ} </span>
  </p>  
#{/if}
#{else}
  #{field 'zprava.bioMaterial.id'}
  <p>
    <label class="required">&{field.name} </label>
    #{select "${field.name}", value:"${zprava?.bioMaterial?.id}", id:"${field.name}", class:"vLongW"}
    	#{option "0"}&{'selectBox.option.select'}#{/option}
      #{list bioMaterialy}
        #{option "${_.id}"}${_.typ}  ${ _.datumOdberu?.yesno(' - ', '') }  ${_.datumOdberu?.format()}#{/option}
      #{/list}
    #{/select}
    <span class="error">#{error 'zprava.bioMaterial.id' /} </span>
  </p>
  #{/}
#{/else}

#{if zprava?.vysetreni?.id}
  <input type="hidden" name="zprava.vysetreni.id" value="${zprava.vysetreni.id}">
  <p>
    <label>název vyšetření</label>
    <span class="infoInput">${zprava?.vysetreni?.nazev} </span>
  </p>  
#{/if}
#{else}
  #{field 'zprava.vysetreni.id'}
  <p>
    <label class="required"l>&{field.name} </label>
    #{select "${field.name}", value:"${zprava?.vysetreni?.id}", id:"${field.name}", class:"vLongW"}
    	#{option "0"}&{'selectBox.option.select'}#{/option}
      #{list vysetreni}
        #{option "${_.id}"}${_.nazev}#{/option}
      #{/list}
    #{/select}
    <span class="error">#{error 'vysetreni.id' /} </span>
  </p>
  #{/}
#{/else}

#{field 'zprava.datumVysetreni'}
<p>
  <label>&{field.name} </label>
  <input type="text" id="${field.id}" name="${field.name}" value="${zprava?.datumVysetreni?.format()}" class="${field.errorClass} datumW">
  #{ifError field.name}<span class="error">${field.error} </span>#{/ifError}
</p>
#{/}

#{field 'zprava.parafaVysetreni.id'}
<p>
  <label>&{field.name} </label>
  #{select "${field.name}", value:"${zprava?.parafaVysetreni?.id}", id:"${field.name}"}
  	#{option }&{'selectBox.option.none'}#{/option}
    #{list users}
      #{option "${_.id}"}${_.jmeno}#{/option}
    #{/list}
  #{/select}
  <span class="error">#{error 'zprava.parafaVysetreni ' /} </span>
</p>
#{/}

#{field 'zprava.parafaUvolneni'}
<p>
  <label>&{field.name} </label>
  <input type="text" id="${field.id}" name="${field.name}" value="${zprava?.parafaUvolneni}" class="${field.errorClass}">
  #{ifError field.name}<span class="error">${field.error} </span>#{/ifError}
  <span class="small">${uvolnujiAnalyzu?.join(', ') } </span>
</p>
#{/}

#{field 'zprava.vedouciLekar'}
<p>
  <label>&{field.name} </label>
  
  <input type="text" id="${field.id}" name="${field.name}" value="${zprava?.vedouciLekar}" class="${field.errorClass}">
  #{ifError field.name}<span class="error">${field.error} </span>#{/ifError}
  <span class="small">${vedouciLekari?.join(', ') } </span>
</p>
#{/}

#{field 'zprava.zavZprava'}
<p>
  <label>&{field.name} </label>
  <textarea id="${field.id}" name="${field.name}" class="${field.errorClass}">${zprava?.zavZprava}</textarea>
  #{ifError field.name}<span class="error">${field.error} </span>#{/ifError}
</p>
#{/}

#{field 'zprava.pozitivni'}
<p>
  <label>&{field.name} </label>
  <input type="checkbox" id="${field.id}" name="${field.name}" #{if zprava?.pozitivni} checked="checked" #{/if} class="${field.errorClass}">
  #{ifError field.name}<span class="error">${field.error} </span>#{/ifError}
</p>
#{/}

#{field 'zprava.datumPCR1'}
<p>
  <label>&{field.name} </label>
  <input type="text" id="${field.id}" name="${field.name}" value="${zprava?.datumPCR1?.format('dd.MM.yyyy')}" class="${field.errorClass} datumW">
  #{ifError field.name}<span class="error">${field.error} </span>#{/ifError}
</p>
#{/}

#{field 'zprava.datumPCR2'}
<p>
  <label>&{field.name} </label>
  <input type="text" id="${field.id}" name="${field.name}" value="${zprava?.datumPCR2?.format('dd.MM.yyyy')}" class="${field.errorClass} datumW">
  #{ifError field.name}<span class="error">${field.error} </span>#{/ifError}
</p>
#{/}

#{field 'zprava.datumElForezy'}
<p>
  <label>&{field.name} </label>
  <input type="text" id="${field.id}" name="${field.name}" value="${zprava?.datumElForezy?.format('dd.MM.yyyy')}" class="${field.errorClass} datumW">
  #{ifError field.name}<span class="error">${field.error} </span>#{/ifError}
</p>
#{/}

#{field 'zprava.datumRevHybrid'}
<p>
  <label>&{field.name} </label>
  <input type="text" id="${field.id}" name="${field.name}" value="${zprava?.datumRevHybrid?.format('dd.MM.yyyy')}" class="${field.errorClass} datumW">
  #{ifError field.name}<span class="error">${field.error} </span>#{/ifError}
</p>
#{/}

#{field 'zprava.datumFragmentAn'}
<p>
  <label>&{field.name} </label>
  <input type="text" id="${field.id}" name="${field.name}" value="${zprava?.datumFragmentAn?.format('dd.MM.yyyy')}" class="${field.errorClass}">
  #{ifError field.name}<span class="error">${field.error} </span>#{/ifError}
</p>
#{/}

#{field 'zprava.datumRTAn'}
<p>
  <label>&{field.name} </label>
  <input type="text" id="${field.id}" name="${field.name}" value="${zprava?.datumRTAn?.format('dd.MM.yyyy')}" class="${field.errorClass} datumW">
  #{ifError field.name}<span class="error">${field.error} </span>#{/ifError}
</p>
#{/}

#{field 'zprava.datumSekv'}
<p>
  <label>&{field.name} </label>
  <input type="text" id="${field.id}" name="${field.name}" value="${zprava?.datumSekv?.format('dd.MM.yyyy')}" class="${field.errorClass} datumW">
  #{ifError field.name}<span class="error">${field.error} </span>#{/ifError}
</p>
#{/}

<input type="hidden" name="pacientId" id="pacientId" value="${pacient?.id}">

  <p>
    <input class="left" type="submit" value="Uložit" />
    #{if zprava?.id}  
    <span class="left button delete">#{a @myDelete(zprava?.id), id:"delButton"}Smazat vyšetření#{/a}</span>
    #{/if}        
  </p>
  <div class="clear"></div>
</fieldset>

#{if zprava?.id}
  </div>

  <div id="dialog-confirm" title="Vyšetření ${zprava?.vysetreni?.nazev}">
  	<p><span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>Opravdu chcete smazat toto vyšetření?</p>
  </div>
  
  <script type="text/javascript">
  $(document).ready(function() {
      $('#dialog-confirm').dialog({
      	resizable: false,
      	height:160,
      	modal: true,
      	autoOpen: false,
      	buttons: {
      		'Smazat': function() {
      		  $( this ).dialog( 'close' );
            window.location.href = $('#delButton').attr('href');       				
      		},
      		'Storno': function() {
      			$( this ).dialog( 'close' );
      		}
      	}
      });    
  
      $('#delButton').click(function () {
        $( "#dialog-confirm" ).dialog('open');
        return false;       
      } );
  } );
  </script>  
#{/if}

#{if zprava?.id}
<div class="span-9 last">
<fieldset class="genotyp">
  <legend>Zjištěný genotyp</legend>
  #{list zprava?.vysledky}
    %{ _.genotyp.nazev = _.genotyp.nazev.replace("->", "&#8594;"); }%
    <p>
      <label>${_.genotyp.nazev.raw()} </label>
      <input type="hidden" name="vysledky[${_.id}].id" value="${_.id}">
      <input type="text" name="vysledky[${_.id}].vysledek" value="${_.vysledek}" class="shortW">
    </p>
  #{/list}
    <p>
        <input type="submit" value="Uložit" />
    </p>
</fieldset>
</div>
#{/if}

#{/form}

<script type="text/javascript">
  $(document).ready(function() {
		$( "#zprava_datumVysetreni" ).datepicker(calSetup);
		$( "#zprava_datumPCR1" ).datepicker(calSetup);
		$( "#zprava_datumPCR2" ).datepicker(calSetup);
		$( "#zprava_datumElForezy" ).datepicker(calSetup);
		$( "#zprava_datumRevHybrid" ).datepicker(calSetup);
		$( "#zprava_datumFragmentAn" ).datepicker(calSetup);
		$( "#zprava_datumRTAn" ).datepicker(calSetup);
		$( "#zprava_datumSekv" ).datepicker(calSetup);


	
		var vedouciLekari = [
      #{list vedouciLekari}
        "${_.raw()}" ${_isLast ? '' : ','}
      #{/list}
    ];

		$( "#zprava_vedouciLekar" ).autocomplete({
			source: vedouciLekari
		});

		var uvolnujiAnalyzu = [
      #{list uvolnujiAnalyzu}
        "${_.raw()}" ${_isLast ? '' : ','}
      #{/list}
    ];

		$( "#zprava_parafaUvolneni" ).autocomplete({
			source: uvolnujiAnalyzu
		});
  } );
</script>
